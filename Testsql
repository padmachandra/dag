SELECT 
    CAST(B.ENEXAN AS FLOAT64) AS ACCT_NO,
    CONCAT(GCCTCD, GCDCG, LPAD(CAST(GCDCB AS STRING), 3, '0')) AS Account_Group,
    FORMAT_DATE("%Y-%m-%d", PARSE_DATE("%Y%m%d", CAST(A.IGCPDT AS STRING))) AS IGCPDT,
    A.IGLMAM AS IGLMAM,
    C.ZBNAD1, C.ZBNAD2, C.ZBNAD3, C.ZBNAD4, C.ZENAD5,
    USSSIDLGP.*,  -- Ensure that all columns here are either aggregated or in the GROUP BY
    ROW_NUMBER() OVER (PARTITION BY IGDCB, IGDCS, IGPPSQ ORDER BY IGTMZ1 DESC) AS RN
FROM 
    proj-123456-cbdocusa-dev.RAW_DS.USSSIDLGP AS USSSIDLGP
    LEFT JOIN proj-123456-cbdocusa-dev.RAW_DS.SSEANFP AS B ON IGCTCD = ENTCTD AND IGACB = ENGMAB AND IGACS = ENACB
    LEFT JOIN proj-123456-cbdocusa-dev.RAW_DS.SSADDRP AS C ON IGCTCD = ZBTCTD AND IGACB = ZBDCG AND IGACS = ZBDCB
    LEFT JOIN proj-123456-cbdocusa-dev.RAW_DS.USSSAGCFP AS D ON IGCTCD = GCCTCD AND IGACB = GCDCG AND IGACS = GCDCB
    LEFT JOIN proj-123456-cbdocusa-dev.RAW_DS.DDACESP AS E ON IGCTCD = DFCTCD AND IGDCG = DFGMAB AND IGDCB = DFACB
WHERE 
    IGRTTP = 'P' 
    AND IGRSC = 'RTP'
    AND IGLMAM IS NOT NULL
    AND ENSCCD = 'DD'
    AND IGMTMS IN ('AP', 'A', 'U')
    AND ZBAID = DFPMIT 
    AND IGRTAP < 0
GROUP BY 
    Account_Group, IGCPDT, IGLMAM, ZBNAD1, ZBNAD2, ZBNAD3, ZBNAD4, ZBNAD5;
